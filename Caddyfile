{
    # Global options block.
    # The email address is used for TLS certificate registration with Let's Encrypt.
    email {$EMAIL}

    # Enable debug mode for initial deployment, comment out in production
    # debug
}

logs.{$DOMAIN_ROOT} {
    # Grafana UI route
    handle_path / {
        reverse_proxy grafana:3000 {
            # Health checks with explicit HTTP scheme
            health_uri http://grafana:3000/api/health
            health_interval 30s
            
            # Timeouts
            transport http {
                tls_timeout 60s
                dial_timeout 60s
                response_header_timeout 60s
            }
            
            # Headers
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Remove identifying headers from the response
    header {
        -Server
        -X-Powered-By
        -X-Grafana-Prod
        
        # Security headers
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob:; connect-src 'self' ws: wss:;"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
    }
    
    # Use Let's Encrypt with OCSP stapling
    tls {
        protocols tls1.2 tls1.3
        curves x25519
        alpn h2 http/1.1
    }

    # Logging with rotation
    log {
        output file /var/log/caddy/grafana_access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}
