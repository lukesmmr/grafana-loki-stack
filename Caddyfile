{
    # Global options block.
    # The email address is used for TLS certificate registration with Let's Encrypt.
    email {$EMAIL}
    
    # Use ZeroSSL as the CA
    acme_ca https://acme.zerossl.com/v2/DV90
    
    # Enable debug mode for initial deployment
    debug
    
    # Caddy's own operations log with rotation and compression
    log {
        output file /var/log/caddy/caddy.log {
        roll_size 10MB
        roll_keep 5
        roll_keep_for 720h
        }
        format json
    }
}

logs.{$DOMAIN_ROOT} {
    # Basic Authentication using environment variables
    basicauth {
        {$BASIC_AUTH_USERNAME} {$BASIC_AUTH_PASSWORD_HASH}
    }

    reverse_proxy grafana:3000 {
        # Health checks with optimized intervals
        health_uri /api/health
        health_interval 60s
        health_timeout 3s
        
        # Optimized upstream configuration
        lb_try_duration 2s
        lb_try_interval 100ms
        
        # Transport configuration with increased buffers
        transport http {
            read_buffer 8192
            write_buffer 8192
            max_response_header 16384
        }
    }
    # Remove identifying headers from the response
    header {
        -Server
        -X-Powered-By
        -X-Grafana-Prod
        
        # Security headers - less restrictive CSP
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' ws: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; worker-src 'self' blob:;"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
    }
    
    # TLS configuration
    tls {
        protocols tls1.2 tls1.3
        curves x25519
        alpn h2 http/1.1
    }

    # Logging with rotation
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format filter {
            wrap console
            fields {
                # Keep User-Agent, Accept-Language, Host, and Referer but remove other headers
                request>headers>Accept delete
                request>headers>Accept-Encoding delete
                request>headers>Cache-Control delete
                request>headers>Connection delete
                request>headers>Cookie delete
                request>headers>Dnt delete
                request>headers>Priority delete
                request>headers>Sec-Ch-Ua delete
                request>headers>Sec-Ch-Ua-Mobile delete
                request>headers>Sec-Ch-Ua-Platform delete
                request>headers>Sec-Fetch-Dest delete
                request>headers>Sec-Fetch-Mode delete
                request>headers>Sec-Fetch-Site delete
                request>headers>Sec-Gpc delete
                # Remove all response headers (including CSP)
                resp_headers delete
                # Remove redundant TLS info
                tls>server_name delete
                tls>resumed delete
                tls>version delete
                tls>cipher_suite delete
                tls>proto delete
            }
        }
    }
}
