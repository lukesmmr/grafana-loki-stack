{
    # Global options block.
    # The email address is used for TLS certificate registration with Let's Encrypt.
    email {$EMAIL}
    
    # Use ZeroSSL as the CA
    acme_ca https://acme.zerossl.com/v2/DV90
    
    # Enable debug mode for initial deployment
    debug
}

logs.{$DOMAIN_ROOT} {
    # Grafana UI route
    handle_path / {
        reverse_proxy * grafana:3000 {
            # Health checks
            health_uri /api/health
            health_interval 30s
            health_timeout 5s
            
            # Upstream configuration
            lb_try_duration 1s
            lb_try_interval 250ms
            
            # Transport configuration
            transport http {
                read_buffer 4096
                write_buffer 4096
                max_response_header 10240
            }
        }
    }
    
    # Remove identifying headers from the response
    header {
        -Server
        -X-Powered-By
        -X-Grafana-Prod
        
        # Security headers
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob:; connect-src 'self' ws: wss:;"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
    }
    
    # TLS configuration
    tls {
        protocols tls1.2 tls1.3
        curves x25519
        alpn h2 http/1.1
    }

    # Logging with rotation
    log {
        output file /var/log/caddy/grafana_access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}
